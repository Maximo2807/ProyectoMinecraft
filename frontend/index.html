<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control de Minecraft</title>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@500&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        .auth-body{margin:0;padding:0;display:flex;justify-content:center;align-items:center;min-height:100vh;font-family:'Jost',sans-serif;background:linear-gradient(to bottom, #0f0c29, #302b63, #24243e);}
        .main-auth{width:350px;height:550px;background:#0f0c29;overflow:hidden;border-radius:10px;box-shadow:5px 20px 50px #000;}
        #chk{display:none;}
        .signup{position:relative;width:100%;height:100%;}
        .auth-label{color:#fff;font-size:2.3em;justify-content:center;display:flex;margin:40px;font-weight:bold;cursor:pointer;transition:.5s ease-in-out;}
        .auth-input{width:60%;height:20px;background:#e0dede;justify-content:center;display:flex;margin:15px auto;padding:10px;border:none;outline:none;border-radius:5px;}
        .auth-button{width:60%;height:40px;margin:10px auto;justify-content:center;display:block;color:#fff;background:#573b8a;font-size:1em;font-weight:bold;margin-top:20px;outline:none;border:none;border-radius:5px;transition:.2s ease-in;cursor:pointer;}
        .auth-button:hover{background:#6d44b8;}
        .login{height:460px;background:#eee;border-radius:60% / 10%;transform:translateY(-180px);transition:.8s ease-in-out;}
        .login .auth-label{color:#573b8a;transform:scale(.6);}
        #chk:checked ~ .login{transform:translateY(-530px);}
        #chk:checked ~ .login .auth-label{transform:scale(1);}
        #chk:checked ~ .signup .auth-label{transform:scale(.6);}
        .dashboard-body{font-family:'Jost',sans-serif;background-color:#111827;color:#E5E7EB;overflow:hidden; position: relative;}
        .animated-bg-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 0; --l: #25ec77; --b: #111827; --c: #fffdfd; background: var(--b); }
        .animated-bg-container::before, .animated-bg-container::after { content: ""; position: absolute; inset: 0; animation: weee 10s linear infinite; background-repeat: repeat-y; background-size: 50px 20px, 50px 20px, 50px 80px, 50px 80px, 50px 80px, 50px 80px, 50px 80px, 50px 80px; --w: 104px; background-position-x: 4px, 54px, calc(var(--w) * 1 + 4px), calc(var(--w) * 1 + 54px), calc(var(--w) * 2 + 4px), calc(var(--w) * 2 + 54px), calc(var(--w) * 3 + 4px), calc(var(--w) * 3 + 54px), calc(var(--w) * 4 + 4px), calc(var(--w) * 4 + 54px); }
        .animated-bg-container::before { animation-name: before-anim-opacity, before-anim-bg, weee; animation-duration: 5s, 5s, 10s; animation-timing-function: linear, step-start, linear; }
        .animated-bg-container::after { animation-name: after-anim-opacity, weee; animation-duration: 5s, 10s; animation-timing-function: linear, linear; background-image: none, none, linear-gradient(45deg, var(--c) 0% 30.77%, transparent 30.77% 61.54%, var(--c) 61.54% 92.31%, transparent 92.31%), linear-gradient(-45deg, var(--c) 0% 30.77%, transparent 30.77% 61.54%, var(--c) 61.54% 92.31%, transparent 92.31%), none, none, linear-gradient(45deg, var(--c) 0% 30.77%, transparent 30.77% 61.54%, var(--c) 61.54% 92.31%, transparent 92.31%), linear-gradient(-45deg, var(--c) 0% 30.77%, transparent 30.77% 61.54%, var(--c) 61.54% 92.31%, transparent 92.31%); }
        @keyframes weee { to { background-position-y: 800px, 800px, 1040px, 1040px, 1360px, 1360px, 1040px, 1040px; } }
        @keyframes after-anim-opacity { 5% { opacity: 1; } 0%, 4.99%, 20%, 100% { opacity: 0; } }
        @keyframes before-anim-opacity { 0%, 10.4% { opacity: 1; } 9.9%, 10.3999%, 30%, 100% { opacity: 0; } }
        @keyframes before-anim-bg { 0%, 9.9%, 99% { background-image: none, none, none, none, linear-gradient(45deg, var(--c) 0% 30.77%, transparent 30.77% 61.54%, var(--c) 61.54% 92.31%, transparent 92.31%), linear-gradient(-45deg, var(--c) 0% 30.77%, transparent 30.77% 61.54%, var(--c) 61.54% 92.31%, transparent 92.31%); } 10%, 40% { background-image: linear-gradient(45deg, var(--c) 0% 14.28%, transparent 14.28% 28.57%, var(--c) 28.57% 42.86%, transparent 42.86% 57.14%, var(--c) 57.14% 71.43%, transparent 71.43% 85.71%, var(--c) 85.71% 100%), linear-gradient(-45deg, var(--c) 0% 14.28%, transparent 14.28% 28.57%, var(--c) 28.57% 42.86%, transparent 42.86% 57.14%, var(--c) 57.14% 71.43%, transparent 71.43% 85.71%, var(--c) 85.71% 100%), none, none, none, none, none, none, linear-gradient(45deg, var(--c) 0% 14.28%, transparent 14.28% 28.57%, var(--c) 28.57% 42.86%, transparent 42.86% 57.14%, var(--c) 57.14% 71.43%, transparent 71.43% 85.71%, var(--c) 85.71% 100%), linear-gradient(-45deg, var(--c) 0% 14.28%, transparent 14.28% 28.57%, var(--c) 28.57% 42.86%, transparent 42.86% 57.14%, var(--c) 57.14% 71.43%, transparent 71.43% 85.71%, var(--c) 85.71% 100%); } }
        .menu{ padding: 0.5rem; background-color: #fff; position: relative; display: flex; justify-content: center; border-radius: 15px; box-shadow: 0 10px 25px 0 rgba(0,0,0, 0.075); }
        .link { display: inline-flex; justify-content: center; align-items: center; width: 70px; height: 50px; border-radius: 8px; position: relative; z-index: 1; overflow: hidden; transform-origin: center left; transition: width 0.2s ease-in; text-decoration: none; color: #111827; }
        .link:before { position: absolute; z-index: -1; content: ""; display: block; border-radius: 8px; width: 100%; height: 100%; top: 0; transform: translateX(100%); transition: transform 0.2s ease-in; transform-origin: center right; background-color: #eee; }
        .link:hover, .link:focus, .link.active { outline: 0; width: 130px; }
        .link:hover:before, .link:focus:before, .link.active:before { transform: translateX(0); }
        .link:hover .link-title, .link:focus .link-title, .link.active .link-title { opacity: 1; transform: translateX(0); }
        .link-icon { width: 28px; height: 28px; display: block; flex-shrink: 0; left: 21px; position: absolute; }
        .link-icon svg { width: 28px; height: 28px; }
        .link-title { transform: translateX(100%); transition: transform 0.2s ease-in, opacity 0.1s ease-in; opacity: 0; transform-origin: center right; display: block; text-align: center; text-indent: 28px; width: 100%; font-weight: bold;}
        .power-switch { font-size: 30px; position: relative; display: inline-block; width: 4em; height: 0.3em; }
        .power-switch input { opacity: 0; width: 0; height: 0; }
        .power-switch .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #900c3f; transition: 0.4s; border-radius: 0.15em; }
        .power-switch .slider:before { position: absolute; content: ""; height: 2em; width: 2em; left: -0.8em; bottom: -0.8em; background-color: white; transition: 0.4s; border-radius: 50%; background-image: url('data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4gHYSUNDX1BST0ZJTEUAAQEAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADb/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCAAQABADASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIG/8QAIxAAAgIABQQDAAAAAAAAAAAAAQMCBAAREiExBUFRcROBsf/EABQBAQAAAAAAAAAAAAAAAAAAAAX/xAAWEQADAAAAAAAAAAAAAAAAAAAAEiL/2gAMAwEAAhEDEQA/AMBTp03dNglMVuttjqnKQ2UPOfntkOThbqVVUJ12BKnogZQZpy+Ucc8knwePWJrWqyqEHVmrTahEBqpbBoAH1n635wt3a9mjN1p8X2pw0qVEbKB/CO/c4OphSVP/2Q=='); background-size: cover; image-rendering: pixelated; }
        .power-switch input:checked + .slider { background-color: #c70039; }
        .power-switch input:checked + .slider:before { transform: translateX(2.8em); background-image: url('data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4gHYSUNDX1BST0ZJTEUAAQEAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADb/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCAAQABADASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAQIEBf/EACMQAAEDAwQDAQEAAAAAAAAAAAQBAgUDESEAEjFBBlFhMkL/xAAUAQEAAAAAAAAAAAAAAAAAAAAF/8QAGBEAAwEBAAAAAAAAAAAAAAAAABIiMUH/2gAMAwEAAhEDEQA/AM+Bg4mS8coRccMOdNG01qVyH/kRvHPKKmMdr8uujPwUTG+NkRpw1AKWCbvHKa2zTGphc9u9p0q+rLqeMl4kSCGkYgtoE0HTahIz3bWGNanPrdyqWzn7p5ibh5CArnyZNMyVLpK0QSkt2BNXtVX+7ol1wuLJiyaHt+6Kyp//2Q=='); }
        .power-switch input:disabled + .slider:before { animation: pulse-yellow 1.5s infinite; }
        .panel-container{background-color:#1F2937;border-radius:8px;padding:16px;border:1px solid #374151;box-shadow:0 4px 6px rgba(0,0,0,.5);}
        .console-container{background-color:#1F2937;border-radius:8px;padding:16px;border:1px solid #374151;box-shadow:0 4px 6px rgba(0,0,0,.5);font-family:'Courier New',Courier,monospace}
        .console-textarea{width:100%;height:400px;background-color:#000;border:1px solid #333;color:#00ff00;font-size:14px;line-height:1.5;resize:none;border-radius:4px}.console-textarea:focus{outline:none}
        .file-explorer-container{background-color:#1F2937;border-radius:8px;padding:16px;border:1px solid #374151;box-shadow:0 4px 6px rgba(0,0,0,.5);font-family:'Courier New',Courier,monospace}
        .file-tree{height:500px;overflow-y:auto;padding-right:1rem;}.file-tree ul{padding-left:1rem;}.file-tree li{list-style:none;margin:0.25rem 0;}.file-tree .file-item{cursor:pointer;display:flex;align-items:center;gap:0.5rem;padding:0.25rem;border-radius:4px;}.file-tree .file-item:hover{background-color:#374151;}
        .file-editor{height:500px;width:100%;background-color:#000;border:1px solid #333;color:#E5E7EB;font-family:'Courier New',Courier,monospace;font-size:14px;padding:1rem;border-radius:4px;resize:none;}
        .player-card{background:#1f2937;border:1px solid #374151;border-radius:1rem;padding:1rem;text-align:center;transition:all .3s ease; display: flex; flex-direction: column; justify-content: space-between;}
        .player-card:hover{transform:translateY(-5px);box-shadow:0 10px 20px rgba(0,0,0,.2);}
        .player-avatar{width:80px;height:80px;border-radius:50%;margin:0 auto .5rem;border:3px solid #4f46e5;object-fit:cover;background-color:#374151;}
        .player-name{font-size:1.25rem;font-weight:600;color:#fff; display: flex; align-items: center; justify-content: center; gap: 0.5rem;}
        .hidden{display:none}
    </style>
</head>
<body id="page-body" class="auth-body">
    <div id="auth-container">
        <div class="main-auth">
            <input type="checkbox" id="chk" aria-hidden="true">
            <div class="signup">
                <form id="register-form">
                    <label for="chk" aria-hidden="true" class="auth-label">Sign up</label>
                    <input type="text" name="username" placeholder="Nombre de Usuario" required class="auth-input">
                    <input type="text" name="firstName" placeholder="Nombre" class="auth-input">
                    <input type="text" name="lastName" placeholder="Apellido" class="auth-input">
                    <input type="date" name="dob" class="auth-input" style="color-scheme: dark;">
                    <input type="password" name="password" placeholder="Contraseña" required class="auth-input">
                    <button type="submit" class="auth-button">Sign up</button>
                    <p id="register-message" class="text-sm text-center hidden text-white"></p>
                </form>
            </div>
            <div class="login">
                <form id="login-form">
                    <label for="chk" aria-hidden="true" class="auth-label">Login</label>
                    <input type="text" name="username" placeholder="Nombre de Usuario" required class="auth-input">
                    <input type="password" name="password" placeholder="Password" required class="auth-input">
                    <p id="login-error" class="text-red-500 text-sm text-center hidden"></p>
                    <button type="submit" class="auth-button">Login</button>
                </form>
            </div>
        </div>
    </div>
    
    <div id="main-dashboard" class="dashboard-body w-full h-screen flex flex-col items-center justify-between p-4 hidden">
        <div class="animated-bg-container"></div>
        <main id="main-content" class="w-full max-w-6xl flex-grow flex items-center justify-center z-10">
            <div id="loader" class="hidden"><span class="loader"></span></div>
            <div id="home-panel" class="content-panel text-center">
                <h1 class="text-5xl md:text-7xl font-bold tracking-tight mb-4 transition-colors duration-500 text-red-500" id="server-ip">play.tuservidor.com</h1>
                <p class="text-gray-400 my-8">Gestionando: <span class="font-mono">ProyectoMinecraft</span></p>
                <label class="power-switch mx-auto"><input type="checkbox" id="power-checkbox" onchange="togglePower()"><span class="slider"></span></label>
            </div>
            <div id="console-panel" class="content-panel hidden w-full"><div class="console-container"><textarea id="console-output" readonly class="console-textarea" placeholder="Conectando..."></textarea><form id="console-command-form" class="mt-2 flex gap-2"><span class="text-green-400 font-mono self-center">&gt;</span><input type="text" id="console-command-input" class="flex-grow bg-gray-900 border border-gray-700 rounded px-2 py-1 text-white font-mono focus:outline-none focus:border-indigo-500" placeholder="Escribe un comando..."><button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-1 rounded">Enviar</button></form></div></div>
            <div id="players-panel" class="content-panel hidden w-full"><h2 class="text-3xl font-bold text-center mb-8">Jugadores Conectados</h2><div id="player-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div></div>
            <div id="mods-panel" class="content-panel hidden w-full max-w-4xl"><h2 class="text-3xl font-bold text-center mb-6">Gestión de Mods</h2><div class="bg-gray-800 p-4 rounded-lg"><h3 class="text-xl font-semibold mb-3 text-white">Mods Instalados</h3><ul id="installed-mods-list" class="space-y-2 max-h-64 overflow-y-auto"></ul></div><div class="mt-6 bg-gray-800 p-4 rounded-lg"><h3 class="text-xl font-semibold mb-3 text-white">Subir Nuevos Mods</h3><form id="upload-mods-form"><input type="file" id="mods-input" multiple accept=".jar" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/><p id="upload-status" class="text-sm mt-2 hidden"></p><button type="submit" class="mt-4 w-full py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white font-bold transition-colors">Subir Mods</button></form></div></div>
            <div id="files-panel" class="content-panel hidden w-full"><div class="file-explorer-container grid grid-cols-1 md:grid-cols-3 gap-4"><div class="col-span-1"><h3 class="text-lg font-bold mb-2 text-white">Archivos del Servidor</h3><div id="file-tree-container" class="file-tree bg-black p-2 rounded"></div></div><div class="col-span-2"><div class="flex justify-between items-center mb-2"><h3 id="editing-file-name" class="text-lg font-bold text-white">Selecciona un archivo</h3><button id="save-file-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-1 rounded hidden" onclick="saveFile()">Guardar Cambios</button></div><textarea id="file-editor" class="file-editor" placeholder="El contenido del archivo aparecerá aquí..." disabled></textarea><p id="file-save-status" class="text-sm mt-2 hidden"></p></div></div></div>
            <div id="settings-panel" class="content-panel hidden w-full max-w-2xl">
                <div class="panel-container">
                    <h2 class="text-3xl font-bold text-center mb-6 text-white">Configuración del Servidor</h2>
                    <form id="version-form">
                        <div class="space-y-4">
                            <div>
                                <label for="mc-version" class="block mb-2 text-sm font-medium text-gray-300">Versión de Minecraft</label>
                                <input type="text" id="mc-version" name="version" class="w-full p-2.5 bg-gray-700 border border-gray-600 text-white rounded-lg" placeholder="Ej: 1.20.1" required>
                            </div>
                            <div>
                                <label for="forge-version" class="block mb-2 text-sm font-medium text-gray-300">Versión de Forge</label>
                                <input type="text" id="forge-version" name="forgeVersion" class="w-full p-2.5 bg-gray-700 border border-gray-600 text-white rounded-lg" placeholder="Ej: 47.4.3" required>
                            </div>
                        </div>
                        <p id="recreate-status" class="text-sm text-center mt-4 hidden"></p>
                        <button type="submit" class="mt-6 w-full py-3 bg-red-600 hover:bg-red-700 rounded-lg text-white font-bold transition-colors">Guardar y Reiniciar Servidor</button>
                    </form>
                </div>
            </div>
        </main>
        <nav class="menu z-10 mb-4">
            <a href="#" class="link active" data-panel="home-panel"><span class="link-icon"><i data-feather="home"></i></span><span class="link-title">Inicio</span></a>
            <a href="#" class="link" data-panel="console-panel"><span class="link-icon"><i data-feather="terminal"></i></span><span class="link-title">Consola</span></a>
            <a href="#" class="link" data-panel="players-panel"><span class="link-icon"><i data-feather="users"></i></span><span class="link-title">Jugadores</span></a>
            <a href="#" class="link" data-panel="mods-panel"><span class="link-icon"><i data-feather="box"></i></span><span class="link-title">Mods</span></a>
            <a href="#" class="link" data-panel="files-panel"><span class="link-icon"><i data-feather="folder"></i></span><span class="link-title">Archivos</span></a>
            <a href="#" class="link" data-panel="settings-panel"><span class="link-icon"><i data-feather="settings"></i></span><span class="link-title">Config</span></a>
            <a href="#" class="link" onclick="logout()"><span class="link-icon"><i data-feather="log-out"></i></span><span class="link-title">Salir</span></a>
        </nav>
    </div>
    <script>
        const API_URL = 'http://localhost:3000';
        let socket = null;
        let playerListInterval = null;
        let statusCheckInterval = null;
        let currentEditingPath = null;
        document.addEventListener('DOMContentLoaded', () => { feather.replace(); document.getElementById('login-form').addEventListener('submit', handleLogin); document.getElementById('register-form').addEventListener('submit', handleRegister); document.getElementById('console-command-form')?.addEventListener('submit', (e) => { e.preventDefault(); sendConsoleCommand(); }); document.getElementById('upload-mods-form')?.addEventListener('submit', handleUploadMods); document.getElementById('version-form')?.addEventListener('submit', handleRecreate); const navItems = document.querySelectorAll('.link'); navItems.forEach(item => { item.addEventListener('click', (e) => { if (item.getAttribute('onclick') === 'logout()') return; e.preventDefault(); const panelId = item.getAttribute('data-panel'); if (panelId) { document.querySelectorAll('.link').forEach(i => i.classList.remove('active')); item.classList.add('active'); showPanel(panelId); } }); }); });
        function showAuthPage(pageId) { document.getElementById('auth-container').classList.remove('hidden'); document.getElementById('main-dashboard').classList.add('hidden'); document.getElementById('page-body').classList.add('auth-body'); document.getElementById('page-body').classList.remove('dashboard-body'); const chk = document.getElementById('chk'); if (chk) { chk.checked = pageId === 'login-page'; } }
        function showPanel(panelId) { const loader = document.getElementById('loader'); const panels = document.querySelectorAll('.content-panel'); loader.classList.remove('hidden'); panels.forEach(p => p.classList.add('hidden')); disconnectConsole(); if (playerListInterval) clearInterval(playerListInterval); if (statusCheckInterval) clearInterval(statusCheckInterval); playerListInterval = null; statusCheckInterval = null; setTimeout(() => { loader.classList.add('hidden'); document.getElementById(panelId)?.classList.remove('hidden'); feather.replace(); if (panelId === 'home-panel') { checkServerStatus(); statusCheckInterval = setInterval(checkServerStatus, 5000); } if (panelId === 'console-panel') connectConsole(); if (panelId === 'players-panel') fetchPlayers(); if (panelId === 'files-panel') loadFiles('/'); if (panelId === 'mods-panel') fetchMods(); }, 500); }
        async function handleLogin(e) { e.preventDefault(); const form = e.target; const data = Object.fromEntries(new FormData(form).entries()); const errorElement = document.getElementById('login-error'); errorElement.classList.add('hidden'); try { const response = await fetch(`${API_URL}/api/auth/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); const result = await response.json(); if (result.success) { document.getElementById('auth-container').classList.add('hidden'); document.getElementById('main-dashboard').classList.remove('hidden'); document.getElementById('page-body').classList.remove('auth-body'); document.getElementById('page-body').classList.add('dashboard-body'); showPanel('home-panel'); } else { errorElement.textContent = result.message; errorElement.classList.remove('hidden'); } } catch (error) { errorElement.textContent = 'Error de conexión con el servidor.'; errorElement.classList.remove('hidden'); } }
        async function handleRegister(e) { e.preventDefault(); const form = e.target; const data = Object.fromEntries(new FormData(form).entries()); const messageElement = document.getElementById('register-message'); messageElement.classList.add('hidden'); try { const response = await fetch(`${API_URL}/api/auth/register`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); const result = await response.json(); messageElement.textContent = result.message; messageElement.classList.remove('hidden'); if (result.success) { messageElement.classList.remove('text-red-500'); messageElement.classList.add('text-green-500'); form.reset(); setTimeout(() => { document.getElementById('chk').checked = true; }, 2000); } else { messageElement.classList.remove('text-green-500'); messageElement.classList.add('text-red-500'); } } catch (error) { messageElement.textContent = 'Error de conexión con el servidor.'; messageElement.classList.add('text-red-500'); messageElement.classList.remove('hidden'); } }
        function logout() { showAuthPage('login-page'); if (statusCheckInterval) clearInterval(statusCheckInterval); }
        function updatePowerUI(status) { const checkbox = document.getElementById('power-checkbox'); const ipElement = document.getElementById('server-ip'); checkbox.disabled = false; checkbox.parentElement.classList.remove('pending'); ipElement.classList.remove('text-green-500', 'text-red-500', 'text-yellow-500'); switch(status) { case 'on': checkbox.checked = true; ipElement.classList.add('text-green-500'); break; case 'off': checkbox.checked = false; ipElement.classList.add('text-red-500'); break; case 'pending': checkbox.disabled = true; checkbox.parentElement.classList.add('pending'); ipElement.classList.add('text-yellow-500'); break; } }
        async function checkServerStatus() { try { const response = await fetch(`${API_URL}/api/server/status`); if (!response.ok) return; const data = await response.json(); updatePowerUI(data.status); } catch (error) { console.error('Error al comprobar estado:', error); updatePowerUI('off'); } }
        function togglePower() { const checkbox = document.getElementById('power-checkbox'); const isOn = checkbox.checked; const endpoint = isOn ? '/api/server/stop' : '/api/server/start'; checkbox.disabled = true; if (isOn) { updatePowerUI('off'); } else { updatePowerUI('pending'); } fetch(`${API_URL}${endpoint}`, { method: 'POST' }).then(res => res.json()).then(data => { console.log(data.message); setTimeout(() => { checkServerStatus(); }, 2500); }).catch(error => { console.error('Error en togglePower:', error); checkServerStatus(); }); }
        function connectConsole() { const consoleOutput = document.getElementById('console-output'); consoleOutput.value = 'Conectando...\n'; socket = io(API_URL); socket.on('connect', () => { consoleOutput.value += '¡Conectado!\n'; }); socket.on('log', (data) => { consoleOutput.value += data.replace(/\[\d+m/g, ''); consoleOutput.scrollTop = consoleOutput.scrollHeight; }); socket.on('disconnect', () => { consoleOutput.value += '\n--- Desconectado ---'; }); }
        function disconnectConsole() { if (socket) { socket.disconnect(); socket = null; } }
        async function sendConsoleCommand() { const input = document.getElementById('console-command-input'), command = input.value.trim(); if (!command) return; try { const response = await fetch(`${API_URL}/api/server/command`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ command: command }) }); const data = await response.json(); if (!data.success) console.error('Error al enviar comando:', data.error); input.value = ''; } catch (error) { console.error('Error de red:', error); } }
        async function fetchPlayers() { const container = document.getElementById('player-list'); try { const response = await fetch(`${API_URL}/api/server/players`); const data = await response.json(); container.innerHTML = ''; if (data.error) { container.innerHTML = `<p class="text-center text-yellow-400 col-span-full">${data.error}</p>`; } else if (data.players.length === 0) { container.innerHTML = `<p class="text-center text-gray-400 col-span-full">No hay jugadores conectados.</p>`; } else { data.players.forEach(player => { const crown = player.isOp ? '<span>👑</span>' : ''; const card = `<div class="player-card"><div><img src="${player.avatar}" alt="Avatar" class="player-avatar" onerror="this.onerror=null;this.src='https://cravatar.eu/helmavatar/steve/80.png';"><p class="player-name">${player.name} ${crown}</p></div><div class="mt-4 flex justify-center gap-2"><button onclick="managePlayer('kick', '${player.name}')" class="text-sm bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-1 px-3 rounded">KICK</button><button onclick="managePlayer('ban', '${player.name}')" class="text-sm bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded">BAN</button></div></div>`; container.innerHTML += card; }); } } catch (error) { container.innerHTML = `<p class="text-center text-red-500 col-span-full">Error al cargar jugadores.</p>`; } if (!playerListInterval) { playerListInterval = setInterval(fetchPlayers, 15000); } }
        async function managePlayer(action, playerName) { if (!confirm(`¿Estás seguro de que quieres hacer '${action}' a ${playerName}?`)) return; try { const response = await fetch(`${API_URL}/api/server/${action}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ player: playerName }) }); const result = await response.json(); alert(result.message || result.error); fetchPlayers(); } catch (error) { alert('Error al ejecutar la acción.'); } }
        async function loadFiles(path) { const container = document.getElementById('file-tree-container'); container.innerHTML = 'Cargando...'; try { const response = await fetch(`${API_URL}/api/files/list?path=${encodeURIComponent(path)}`); const files = await response.json(); if (!response.ok) throw new Error(files.details || 'Error del servidor'); const tree = document.createElement('ul'); if (path !== '/') { const parentPath = path.substring(0, path.lastIndexOf('/')) || '/'; const upItem = document.createElement('li'); upItem.innerHTML = `<div class="file-item text-yellow-400"><i data-feather="corner-left-up"></i> ..</div>`; upItem.onclick = () => loadFiles(parentPath); tree.appendChild(upItem); } files.sort((a, b) => (a.type === b.type) ? a.name.localeCompare(b.name) : (a.type === 'directory' ? -1 : 1)); files.forEach(file => { const item = document.createElement('li'); const fullPath = `${path}${path.endsWith('/') ? '' : "/"}${file.name}`; const deleteBtn = `<button onclick="event.stopPropagation(); deleteFile('${fullPath}', '${file.type}', () => loadFiles('${path}'))" class="ml-auto text-red-500 hover:text-red-400"><i data-feather="trash-2" class="w-4 h-4"></i></button>`; if (file.type === 'directory') { item.innerHTML = `<div class="file-item text-blue-400"><i data-feather="folder"></i><span>${file.name}</span>${deleteBtn}</div>`; item.onclick = () => loadFiles(fullPath); } else { item.innerHTML = `<div class="file-item"><i data-feather="file-text"></i><span>${file.name}</span>${deleteBtn}</div>`; item.onclick = () => loadFileContent(fullPath); } tree.appendChild(item); }); container.innerHTML = ''; container.appendChild(tree); feather.replace(); } catch (error) { container.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`; } }
        async function loadFileContent(path) { const editor = document.getElementById('file-editor'), nameEl = document.getElementById('editing-file-name'), saveBtn = document.getElementById('save-file-button'); nameEl.textContent = 'Cargando...'; editor.value = ''; editor.disabled = true; saveBtn.classList.add('hidden'); currentEditingPath = null; try { const response = await fetch(`${API_URL}/api/files/content?path=${encodeURIComponent(path)}`); if (!response.ok) throw new Error('No se pudo cargar.'); const content = await response.text(); editor.value = content; nameEl.textContent = path.split('/').pop(); editor.disabled = false; saveBtn.classList.remove('hidden'); currentEditingPath = path; } catch (error) { nameEl.textContent = 'Error'; editor.value = `Error: ${error.message}`; } }
        async function saveFile() { if (!currentEditingPath) return; const editor = document.getElementById('file-editor'), statusEl = document.getElementById('file-save-status'), saveBtn = document.getElementById('save-file-button'); statusEl.textContent = 'Guardando...'; statusEl.className = 'text-sm mt-2 text-yellow-400'; statusEl.classList.remove('hidden'); saveBtn.disabled = true; try { const response = await fetch(`${API_URL}/api/files/save`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ path: currentEditingPath, content: editor.value }) }); const result = await response.json(); if (!result.success) throw new Error(result.details || 'Error'); statusEl.textContent = '¡Guardado!'; statusEl.className = 'text-sm mt-2 text-green-500'; } catch (error) { statusEl.textContent = `Error: ${error.message}`; statusEl.className = 'text-sm mt-2 text-red-500'; } finally { saveBtn.disabled = false; setTimeout(() => statusEl.classList.add('hidden'), 3000); } }
        async function fetchMods() { const list = document.getElementById('installed-mods-list'); list.innerHTML = '<li>Cargando mods...</li>'; try { const response = await fetch(`${API_URL}/api/mods/list`); const mods = await response.json(); list.innerHTML = ''; if (mods.length === 0) { list.innerHTML = '<li>No hay mods instalados.</li>'; } else { mods.forEach(modName => { const li = document.createElement('li'); li.className = 'flex justify-between items-center bg-gray-700 p-2 rounded'; li.innerHTML = `<span class="text-white">${modName}</span><button onclick="deleteFile('/mods/${modName}', 'file', fetchMods)" class="text-red-500 hover:text-red-400"><i data-feather="trash-2" class="w-4 h-4"></i></button>`; list.appendChild(li); }); feather.replace(); } } catch (error) { list.innerHTML = '<li>Error al cargar los mods.</li>'; } }
        async function handleUploadMods(e) { e.preventDefault(); const input = document.getElementById('mods-input'); const status = document.getElementById('upload-status'); if (input.files.length === 0) { status.textContent = 'Por favor, selecciona al menos un archivo.'; status.className = 'text-sm mt-2 text-yellow-400'; status.classList.remove('hidden'); return; } const formData = new FormData(); for (const file of input.files) { formData.append('mods', file); } status.textContent = 'Subiendo...'; status.className = 'text-sm mt-2 text-yellow-400'; status.classList.remove('hidden'); try { const response = await fetch(`${API_URL}/api/mods/upload`, { method: 'POST', body: formData }); const result = await response.json(); status.textContent = result.message; status.className = 'text-sm mt-2 text-green-500'; input.value = ''; fetchMods(); } catch (error) { status.textContent = 'Error al subir los mods.'; status.className = 'text-sm mt-2 text-red-500'; } }
        async function deleteFile(path, type, callbackOnSuccess) { if (!confirm(`¿Estás seguro de que quieres borrar '${path}'? Esta acción no se puede deshacer.`)) return; try { await fetch(`${API_URL}/api/files/delete`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ path, type }), }); if (callbackOnSuccess) callbackOnSuccess(); } catch (error) { alert('Error al borrar el elemento.'); } }
        async function handleRecreate(e) { e.preventDefault(); if (!confirm('¿Estás seguro? Esto detendrá y recreará el servidor con las nuevas versiones. El mundo y los datos se conservarán, pero el proceso puede tardar varios minutos.')) return; const form = e.target; const data = Object.fromEntries(new FormData(form).entries()); const statusEl = document.getElementById('recreate-status'); statusEl.textContent = 'Iniciando proceso de recreación... No cierres esta página.'; statusEl.className = 'text-sm text-center mt-4 text-yellow-400'; statusEl.classList.remove('hidden'); try { const response = await fetch(`${API_URL}/api/server/recreate`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); const result = await response.json(); if (result.success) { statusEl.textContent = '¡Éxito! El servidor se está recreando. Ve al panel de inicio para monitorear el estado.'; statusEl.className = 'text-sm text-center mt-4 text-green-500'; } else { throw new Error(result.message || 'Error desconocido'); } } catch (error) { statusEl.textContent = `Error: ${error.message}`; statusEl.className = 'text-sm text-center mt-4 text-red-500'; } }
    </script>
</body>
</html>
